<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Robert Smith — Projects & Case Studies</title>
  <meta name="description" content="Reliability engineering projects and case studies: Problem → Analysis → Action → Outcome." />
  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=2">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=2">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=2">
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="/assets/css/style.css?v=34" />
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <style>
    /* Page-scoped small additions */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    .preview.paao .sep{opacity:.6;padding:0 .25rem}
    .case-dialog .case-media{display:flex;justify-content:center;align-items:center;min-height:240px;margin:0 0 .75rem}
    .case-dialog .case-media img{max-width:100%;height:auto;cursor:pointer}
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="site-header" role="banner">
    <div class="container">
      <nav class="nav" aria-label="Primary">
        <a class="brand-logo" href="/" aria-label="Go to home">
          <img src="/assets/img/logo.svg" alt="RS logo" loading="eager" decoding="async">
          <span class="brand-text">Robert Smith</span>
        </a>
        <button class="menu-toggle" aria-expanded="false" aria-controls="nav-links" aria-label="Toggle menu">
          <span class="bar"></span><span class="bar"></span><span class="bar"></span>
        </button>
        <div id="nav-links" class="nav-links">
          <a href="/">Home</a>
          <a href="/pages/projects.html" class="active" aria-current="page">Projects</a>
          <a href="/pages/cad.html">CAD</a>
          <a href="/pages/personal.html">Personal</a>
          <a href="/pages/resume.html">Resume</a>
          <a href="/pages/contact.html" class="btn btn-sm">Contact</a>
        </div>
      </nav>
    </div>
  </header>

  <!-- Subhero -->
  <section class="subhero hero" data-aos="fade-up" aria-label="Projects intro">
    <div class="container">
      <h1>Projects & Case Studies</h1>
      <p class="lede">PAAO: <strong>Problem</strong> → <strong>Analysis</strong> → <strong>Action</strong> → <strong>Outcome</strong></p>
    </div>
  </section>

  <main id="main" class="section" aria-label="Projects list">
    <div class="container container-wide">
      <!-- Filter bar -->
      <div class="project-filters" role="group" aria-label="Filter projects">
        <button class="chip is-active" data-filter="all" aria-pressed="true">All</button>
        <button class="chip" data-filter="rcm" aria-pressed="false">RCM</button>
        <button class="chip" data-filter="condition" aria-pressed="false">Condition</button>
        <button class="chip" data-filter="planning" aria-pressed="false">Planning</button>
        <button class="chip" data-filter="dashboards" aria-pressed="false">Dashboards</button>
        <button class="chip" data-filter="qa" aria-pressed="false">QA</button>
      </div>
      <p class="sr-only" aria-live="polite" id="filterStatus"></p>

      <!-- Cards grid (unchanged content from your current file) -->
      <div class="project-grid">
        <!-- (…your 9 project cards, unchanged…) -->
      </div>
    </div>
  </main>

  <footer class="site-footer" role="contentinfo">
    <div class="container"><p class="copyright">© 2025 Robert Smith</p></div>
  </footer>

  <!-- ===== Templates & dialog markup preserved exactly as you had ===== -->
  <!-- (… your <template id="case-…"> blocks and <dialog class="case-dialog"> …) -->

  <!-- AOS (deferred) + shared navbar behaviors -->
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer></script>
  <script src="/assets/js/navbar.js" defer></script>

  <!-- Page-specific: modal/filter wiring (kept from your file) -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // ===== Case dialog wiring (Next/Prev + multi-image + focus restore) =====
      const cards = Array.from(document.querySelectorAll('.project-card'));
      const ids = cards.map(c => c.getAttribute('data-case')).filter(Boolean);
      const dlg = document.querySelector('.case-dialog');
      const dlgImg = dlg.querySelector('.case-media img');
      const dlgBody = dlg.querySelector('.case-body');
      const btnClose = dlg.querySelector('.case-close');
      const btnPrev = dlg.querySelector('.case-prev');
      const btnNext = dlg.querySelector('.case-next');
      let currentIndex = 0;
      let gallery = []; let galleryIdx = 0; let lastFocus = null;

      function loadCase(id){
        const tpl = document.getElementById('case-' + id);
        if (!tpl) return;
        dlgBody.innerHTML = ''; gallery = []; galleryIdx = 0;
        const frag = tpl.content.cloneNode(true);
        frag.querySelectorAll('img').forEach(img => {
          gallery.push({ src: img.getAttribute('src'), alt: img.getAttribute('alt') || '' });
          img.remove();
        });
        if (gallery.length) { dlgImg.src = gallery[0].src; dlgImg.alt = gallery[0].alt; galleryIdx = 0; }
        else { dlgImg.src = ''; dlgImg.alt = ''; }
        dlgBody.appendChild(frag);
      }
      function openCaseAt(index){
        currentIndex = (index + ids.length) % ids.length;
        loadCase(ids[currentIndex]);
        lastFocus = document.activeElement;
        if (typeof dlg.showModal === 'function') dlg.showModal();
        setHashForCurrent(); btnClose && btnClose.focus();
      }
      function stepCase(dir){ openCaseAt(currentIndex + dir); }
      function stepImage(dir){
        if (!gallery.length) return;
        galleryIdx = (galleryIdx + dir + gallery.length) % gallery.length;
        dlgImg.src = gallery[galleryIdx].src;
        dlgImg.alt = gallery[galleryIdx].alt || '';
      }
      cards.forEach((card, i) => {
        const btn = card.querySelector('.project-open');
        if (!btn) return;
        btn.addEventListener('click', () => openCaseAt(i));
        btn.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openCaseAt(i); } });
      });
      btnClose.addEventListener('click', () => { dlg.close(); clearHashCase(); if (lastFocus && document.body.contains(lastFocus)) lastFocus.focus(); });
      btnPrev.addEventListener('click', () => stepCase(-1));
      btnNext.addEventListener('click', () => stepCase(1));
      dlgImg.addEventListener('click', (e) => stepImage(e.shiftKey ? -1 : 1));
      dlg.addEventListener('click', (e) => { if (e.target === dlg) { dlg.close(); clearHashCase(); if (lastFocus && document.body.contains(lastFocus)) lastFocus.focus(); }});
      document.addEventListener('keydown', (e) => {
        if (!dlg.open) return;
        if (e.key === 'Escape') { dlg.close(); clearHashCase(); if (lastFocus && document.body.contains(lastFocus)) lastFocus.focus(); }
        if (e.key === 'ArrowRight') stepCase(1);
        if (e.key === 'ArrowLeft') stepCase(-1);
        if (e.key === 'PageDown') stepImage(1);
        if (e.key === 'PageUp') stepImage(-1);
      });

      // ===== Tag badges from data-tags =====
      function normalizeTags(str){ return (str || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean); }
      function ensureTagBadges(card){
        if (card.querySelector('.card-tags')) return;
        const tags = normalizeTags(card.getAttribute('data-tags')); if (!tags.length) return;
        const wrap = document.createElement('div'); wrap.className = 'card-tags';
        const brief = card.querySelector('.preview'); const head  = card.querySelector('h3');
        if (brief && brief.parentNode) brief.parentNode.insertBefore(wrap, brief);
        else if (head && head.parentNode) head.parentNode.insertBefore(wrap, head.nextSibling);
        else card.prepend(wrap);
        tags.forEach(t => { const s = document.createElement('span'); s.className = 'card-tag'; s.textContent = t.charAt(0).toUpperCase() + t.slice(1); wrap.appendChild(s); });
      }
      cards.forEach(ensureTagBadges);

      // ===== Filtering =====
      const chips  = Array.from(document.querySelectorAll('.project-filters .chip'));
      const status = document.getElementById('filterStatus');
      function applyFilter(tag){
        const t = (tag || 'all').toLowerCase();
        const params = new URLSearchParams(location.search);
        if (t === 'all') params.delete('filter'); else params.set('filter', t);
        const newUrl = location.pathname + (params.toString() ? '?' + params.toString() : '') + location.hash;
        try { history.replaceState({}, '', newUrl); } catch(_) {}
        let visible = 0;
        cards.forEach(card => {
          const tags = normalizeTags(card.getAttribute('data-tags'));
          const show = (t === 'all') || tags.includes(t);
          card.hidden = !show; if (show) visible++;
        });
        chips.forEach(c => {
          const on = c.dataset.filter === t || (t === 'all' && c.dataset.filter === 'all');
          c.classList.toggle('is-active', on); c.setAttribute('aria-pressed', on ? 'true' : 'false');
        });
        if (status) status.textContent = `${visible} project${visible === 1 ? '' : 's'} shown for filter: ${t}.`;
      }
      chips.forEach(ch => ch.addEventListener('click', () => applyFilter(ch.dataset.filter)));

      // Deep-linking
      function setHashForCurrent(){
        const id = ids[currentIndex];
        const params = new URLSearchParams(location.search);
        const url = location.pathname + (params.toString() ? '?' + params.toString() : '') + '#case-' + id;
        try { history.replaceState({}, '', url); } catch(_) {}
      }
      function clearHashCase(){
        const params = new URLSearchParams(location.search);
        const url = location.pathname + (params.toString() ? '?' + params.toString() : '');
        try { history.replaceState({}, '', url); } catch(_) {}
      }
      function openFromUrl(){
        const params = new URLSearchParams(location.search);
        applyFilter(params.get('filter') || 'all');
        const hash = location.hash || '';
        const m = hash.match(/^#case-([a-z0-9_-]+)$/i);
        if (m) {
          const idx = ids.indexOf(m[1]);
          if (idx >= 0) openCaseAt(idx);
        }
      }
      window.addEventListener('hashchange', () => {
        const m = (location.hash || '').match(/^#case-([a-z0-9_-]+)$/i);
        if (!m) { if (dlg && dlg.open) { dlg.close(); clearHashCase(); if (lastFocus && document.body.contains(lastFocus)) lastFocus.focus(); } return; }
        const idx = ids.indexOf(m[1]);
        if (idx >= 0) openCaseAt(idx);
      });

      applyFilter(new URLSearchParams(location.search).get('filter') || 'all');
      openFromUrl();
    });
  </script>
</body>
</html>
