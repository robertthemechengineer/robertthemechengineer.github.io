<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Robert Smith — Projects & Case Studies</title>
  <meta name="description" content="Reliability engineering projects and case studies: Problem → Analysis → Action → Outcome." />

  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=2">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=2">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=2">

  <!-- Perf -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>

  <!-- Site CSS (bump cache) -->
  <link rel="stylesheet" href="/assets/css/style.css?v=33" />
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

  <style>
    .project-filters{display:flex;flex-wrap:wrap;gap:.5rem;margin:0 0 1.25rem}
    .project-filters .chip{border:1px solid var(--border);background:var(--card);
      padding:.4rem .75rem;border-radius:999px;cursor:pointer;font:inherit;color:var(--text)}
    .project-filters .chip.is-active{box-shadow:0 0 0 2px var(--brand) inset;color:var(--brand)}
    .project-card[hidden]{display:none !important}
    .case-dialog{max-width:min(980px,95vw)}
    .case-dialog .case-media{display:flex;justify-content:center;align-items:center;min-height:240px;margin:0 0 .75rem}
    .case-dialog .case-media img{max-width:100%;height:auto;cursor:pointer}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    .paao-badges{display:flex;gap:6px;margin:0 0 6px;padding:0;list-style:none}
    .paao-badges .paao{font-size:.75rem;line-height:1;padding:4px 6px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03);}
  </style>

</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="site-header" role="banner">
    <div class="container">
      <nav class="nav" aria-label="Primary">
        <a class="brand-logo" href="/" aria-label="Go to home">
          <img src="/assets/img/logo.svg" alt="RS logo" loading="eager" decoding="async">
          <span class="brand-text">Robert Smith</span>
        </a>
        <button class="menu-toggle" aria-expanded="false" aria-controls="nav-links" aria-label="Toggle menu">
          <span class="bar"></span><span class="bar"></span><span class="bar"></span>
        </button>
        <div id="nav-links" class="nav-links">
          <a href="/">Home</a>
          <a href="/pages/projects.html" class="active" aria-current="page">Projects</a>
          <a href="/pages/cad.html">CAD</a>
          <a href="/pages/personal.html">Personal</a>
          <a href="/pages/resume.html">Resume</a>
          <a href="/pages/contact.html" class="btn btn-sm">Contact</a>
        </div>
      </nav>
    </div>
  </header>

  <!-- Subhero -->
  <section class="subhero hero" data-aos="fade-up" aria-label="Projects intro">
    <div class="container">
      <p class="overline">Projects</p>
      <h1>Projects & Case Studies</h1>
      <p class="lede">PAAO: <strong>Problem</strong> → <strong>Analysis</strong> → <strong>Action</strong> → <strong>Outcome</strong></p>
    </div>
  </section>

  <main id="main" class="section" aria-label="Projects list">
    <div class="container container-wide">
      <div class="project-filters" role="group" aria-label="Filter projects">
        <button class="chip is-active" data-filter="all" aria-pressed="true">All</button>
        <button class="chip" data-filter="rcm" aria-pressed="false">RCM</button>
        <button class="chip" data-filter="condition" aria-pressed="false">Condition</button>
        <button class="chip" data-filter="planning" aria-pressed="false">Planning</button>
        <button class="chip" data-filter="dashboards" aria-pressed="false">Dashboards</button>
        <button class="chip" data-filter="qa" aria-pressed="false">QA</button>
      </div>
      <p class="sr-only" aria-live="polite" id="filterStatus"></p>

      <div class="project-grid">
        <!-- 1 -->
        <article class="project-card card" data-aos="fade-up" data-case="d375" data-tags="condition,rca">
          <button class="project-open" aria-label="Open case study: Komatsu D375 — Water Pump Failure RCA">
            <img class="thumb" src="/assets/img/projects/d375_thumb.jpg" alt="Komatsu D375 water pump assembly"
                 loading="lazy" decoding="async" sizes="(max-width: 900px) 100vw, 360px">
            <div class="project-body">
              <ul class="paao-badges" aria-label="PAAO elements"><li class="paao" title="Problem">P</li><li class="paao" title="Analysis">Ana</li><li class="paao" title="Action">Act</li><li class="paao" title="Outcome">Out</li></ul><h3>Komatsu D375 — Water Pump RCA</h3>
              <p class="preview">
                <strong>P:</strong> Repeat driven-gear damage. 
                <strong>Ana:</strong> Teardown + service history. 
                <strong>Act:</strong> Tasks aligned, contamination barriers. 
                <strong>Out:</strong> Repeat reduced; engines protected.
              </p>
            </div>
          </button>
        </article>

        <!-- 2 -->
        <article class="project-card card" data-aos="fade-up" data-aos-delay="40" data-case="service" data-tags="dashboards,planning">
          <button class="project-open" aria-label="Open case study: Service Planning Dashboard">
            <img class="thumb" src="/assets/img/projects/service_dash_thumb.jpg" alt="Service planning dashboard"
                 loading="lazy" decoding="async" sizes="(max-width: 900px) 100vw, 360px">
            <div class="project-body">
              <ul class="paao-badges" aria-label="PAAO elements"><li class="paao" title="Problem">P</li><li class="paao" title="Analysis">Ana</li><li class="paao" title="Action">Act</li><li class="paao" title="Outcome">Out</li></ul><h3>Service Planning Dashboard</h3>
              <p class="preview">
                <strong>P:</strong> Missed/late services. 
                <strong>Ana:</strong> Data sources mapped. 
                <strong>Act:</strong> BI tracker + due windows. 
                <strong>Out:</strong> ~33% ↑ accuracy.
              </p>
            </div>
          </button>
        </article>

        <!-- 3 -->
        <article class="project-card card" data-aos="fade-up" data-aos-delay="80" data-case="condition" data-tags="condition">
          <button class="project-open" aria-label="Open case study: Condition Monitoring Program">
            <img class="thumb" src="/assets/img/projects/condition_thumb.jpg" alt="Condition monitoring checks"
                 loading="lazy" decoding="async" sizes="(max-width: 900px) 100vw, 360px">
            <div class="project-body">
              <ul class="paao-badges" aria-label="PAAO elements"><li class="paao" title="Problem">P</li><li class="paao" title="Analysis">Ana</li><li class="paao" title="Action">Act</li><li class="paao" title="Outcome">Out</li></ul><h3>Condition Monitoring Program</h3>
              <p class="preview">
                <strong>P:</strong> Unclear precursors. 
                <strong>Ana:</strong> Failures reviewed; signals defined. 
                <strong>Act:</strong> Oil/filter analysis; mag plugs; trends. 
                <strong>Out:</strong> Earlier alerts.
              </p>
            </div>
          </button>
        </article>

        <!-- 4 -->
        <article class="project-card card" data-aos="fade-up" data-aos-delay="120" data-case="undercarriage" data-tags="planning">
          <button class="project-open" aria-label="Open case study: Dozer Undercarriage Life Planning">
            <img class="thumb" src="/assets/img/projects/undercarriage_thumb.jpg" alt="Dozer undercarriage"
                 loading="lazy" decoding="async" sizes="(max-width: 900px) 100vw, 360px">
            <div class="project-body">
              <ul class="paao-badges" aria-label="PAAO elements"><li class="paao" title="Problem">P</li><li class="paao" title="Analysis">Ana</li><li class="paao" title="Action">Act</li><li class="paao" title="Outcome">Out</li></ul><h3>Undercarriage Life Planning</h3>
              <p class="preview">
                <strong>P:</strong> Unpredictable UC replacements. 
                <strong>Ana:</strong> Wear vs hours; soil; behavior. 
                <strong>Act:</strong> Forecast + staggered swaps. 
                <strong>Out:</strong> Smoother budgets, ↑ availability.
              </p>
            </div>
          </button>
        </article>

        <!-- 5 -->
        <article class="project-card card" data-aos="fade-up" data-aos-delay="160" data-case="componentqa" data-tags="qa">
          <button class="project-open" aria-label="Open case study: Component Tracking & QA">
            <img class="thumb" src="/assets/img/projects/componentqa_thumb.jpg" alt="Component QA checks"
                 loading="lazy" decoding="async" sizes="(max-width: 900px) 100vw, 360px">
            <div class="project-body">
              <ul class="paao-badges" aria-label="PAAO elements"><li class="paao" title="Problem">P</li><li class="paao" title="Analysis">Ana</li><li class="paao" title="Action">Act</li><li class="paao" title="Outcome">Out</li></ul><h3>Component Tracking & QA</h3>
              <p class="preview">
                <strong>P:</strong> No traceability on sub-assemblies. 
                <strong>Ana:</strong> History + modes mapped. 
                <strong>Act:</strong> IDs; QA checklists; receiving insp. 
                <strong>Out:</strong> Fewer repeats.
              </p>
            </div>
          </button>
        </article>

        <!-- 6 -->
        <article class="project-card card" data-aos="fade-up" data-aos-delay="200" data-case="tasklib" data-tags="rcm">
          <button class="project-open" aria-label="Open case study: Preventive Task Library (RCM)">
            <img class="thumb" src="/assets/img/projects/tasklib_thumb.jpg" alt="Preventive task library"
                 loading="lazy" decoding="async" sizes="(max-width: 900px) 100vw, 360px">
            <div class="project-body">
              <ul class="paao-badges" aria-label="PAAO elements"><li class="paao" title="Problem">P</li><li class="paao" title="Analysis">Ana</li><li class="paao" title="Action">Act</li><li class="paao" title="Outcome">Out</li></ul><h3>Preventive Task Library (RCM)</h3>
              <p class="preview">
                <strong>P:</strong> Inconsistent tasks. 
                <strong>Ana:</strong> OEM vs actuals compared. 
                <strong>Act:</strong> Standard library + intervals. 
                <strong>Out:</strong> Fewer misses.
              </p>
            </div>
          </button>
        </article>

        <!-- 7 -->
        <article class="project-card card" data-aos="fade-up" data-aos-delay="240" data-case="rcmhaul" data-tags="rcm,planning">
          <button class="project-open" aria-label="Open case study: ADT Haul Cycle RCM">
            <img class="thumb" src="/assets/img/projects/rcmhaul_thumb.jpg" alt="ADT haul cycle"
                 loading="lazy" decoding="async" sizes="(max-width: 900px) 100vw, 360px">
            <div class="project-body">
              <ul class="paao-badges" aria-label="PAAO elements"><li class="paao" title="Problem">P</li><li class="paao" title="Analysis">Ana</li><li class="paao" title="Action">Act</li><li class="paao" title="Outcome">Out</li></ul><h3>ADT Haul Cycle RCM</h3>
              <p class="preview">
                <strong>P:</strong> Haul cycle downtime. 
                <strong>Ana:</strong> Modes across drivetrain. 
                <strong>Act:</strong> Tasks + intervals tuned. 
                <strong>Out:</strong> Availability ↑.
              </p>
            </div>
          </button>
        </article>

        <!-- 8 -->
        <article class="project-card card" data-aos="fade-up" data-aos-delay="280" data-case="filterskid" data-tags="condition,qa">
          <button class="project-open" aria-label="Open case study: Filter Skid & Contamination Barriers">
            <img class="thumb" src="/assets/img/projects/filterskid_thumb.jpg" alt="Filter skid"
                 loading="lazy" decoding="async" sizes="(max-width: 900px) 100vw, 360px">
            <div class="project-body">
              <ul class="paao-badges" aria-label="PAAO elements"><li class="paao" title="Problem">P</li><li class="paao" title="Analysis">Ana</li><li class="paao" title="Action">Act</li><li class="paao" title="Outcome">Out</li></ul><h3>Filter Skid & Contamination Barriers</h3>
              <p class="preview">
                <strong>P:</strong> Particulate ingress. 
                <strong>Ana:</strong> Failure traces; ports. 
                <strong>Act:</strong> Skid; quick-connects; seals. 
                <strong>Out:</strong> Cleaner systems.
              </p>
            </div>
          </button>
        </article>

        <!-- 9 -->
        <article class="project-card card" data-aos="fade-up" data-aos-delay="320" data-case="spares" data-tags="planning">
          <button class="project-open" aria-label="Open case study: Critical Spares Planning">
            <img class="thumb" src="/assets/img/projects/spares_thumb.jpg" alt="Critical spares planning board"
                 loading="lazy" decoding="async" sizes="(max-width: 900px) 100vw, 360px">
            <div class="project-body">
              <ul class="paao-badges" aria-label="PAAO elements"><li class="paao" title="Problem">P</li><li class="paao" title="Analysis">Ana</li><li class="paao" title="Action">Act</li><li class="paao" title="Outcome">Out</li></ul><h3>Critical Spares Planning</h3>
              <p class="preview">
                <strong>P:</strong> Stockouts on critical parts. 
                <strong>Ana:</strong> MTBF + lead time review. 
                <strong>Act:</strong> Min/Max; vendor agreements. 
                <strong>Out:</strong> Fewer delays.
              </p>
            </div>
          </button>
        </article>
      </div>
    </div>
  </main>

  <footer class="site-footer" role="contentinfo">
    <div class="container"><p class="copyright">© 2025 Robert Smith</p></div>
  </footer>

  <!-- ===== Hidden templates (full write-ups with multiple images) ===== -->
  <!-- Example: put multiple <img> inside each template; the modal will create a mini-carousel -->
  <template id="case-d375">
    <h2>Komatsu D375 — Water Pump Failure RCA</h2>
    <p><strong>Problem:</strong> Repeated driven-gear damage risking contamination and downtime.</p>
    <p><strong>Analysis:</strong> Teardown with OEM; inspected wear patterns; reviewed history; checked tolerances and contamination paths.</p>
    <p><strong>Action:</strong> Aligned tasks (inspection intervals, torque specs), added contamination barriers & QA checklists; vendor feedback loop.</p>
    <p><strong>Outcome:</strong> Repeat incidents down; earlier detection; engine protection up.</p>
    <img src="/assets/img/projects/d375_full_1.jpg" alt="Water pump teardown overview">
    <img src="/assets/img/projects/d375_full_2.jpg" alt="Driven gear wear pattern close-up">
  </template>

  <template id="case-service">
    <h2>Service Planning Dashboard</h2>
    <p><strong>Problem:</strong> Missed/late services due to fragmented data.</p>
    <p><strong>Analysis:</strong> Mapped sources (hours, locations, due windows) and failure to surface upcoming services.</p>
    <p><strong>Action:</strong> Built Power BI dashboard with KPI tiles and daily refresh.</p>
    <p><strong>Outcome:</strong> ~33% ↑ service accuracy; fewer fire-drills.</p>
    <img src="/assets/img/projects/service_dash_full_1.jpg" alt="Dashboard overview">
    <img src="/assets/img/projects/service_dash_full_2.jpg" alt="KPI tiles detail">
  </template>

  <template id="case-condition">
    <h2>Condition Monitoring Program</h2>
    <p><strong>Problem:</strong> Unclear failure precursors.</p>
    <p><strong>Analysis:</strong> Reviewed past failures; defined signals (wear metals, mag plug debris, temp trends).</p>
    <p><strong>Action:</strong> Routine inspections; oil & filter analysis cadence; mag plug photo log; trend dashboards.</p>
    <p><strong>Outcome:</strong> Earlier alerts; extended component life.</p>
    <img src="/assets/img/projects/condition_full_1.jpg" alt="Oil sample analysis">
    <img src="/assets/img/projects/condition_full_2.jpg" alt="Mag plug debris photo log">
  </template>

  <template id="case-undercarriage">
    <h2>Dozer Undercarriage Life Planning</h2>
    <p><strong>Problem:</strong> Unpredictable replacements causing cost spikes and downtime.</p>
    <p><strong>Analysis:</strong> Tracked wear vs. hours; soil conditions; operator behavior; vendor specs.</p>
    <p><strong>Action:</strong> Forecast model; staggered replacements; stock planning; vendor agreements.</p>
    <p><strong>Outcome:</strong> Smoother budgets; availability ↑; fewer critical outages.</p>
    <img src="/assets/img/projects/undercarriage_full_1.jpg" alt="Roller/sprocket wear log">
    <img src="/assets/img/projects/undercarriage_full_2.jpg" alt="Forecast replacement curve">
  </template>

  <template id="case-componentqa">
    <h2>Component Tracking & QA</h2>
    <p><strong>Problem:</strong> No traceability on sub-assembly work; repeats not linked to root fixes.</p>
    <p><strong>Analysis:</strong> Mapped component history and failure modes across vendors.</p>
    <p><strong>Action:</strong> Unique IDs; QA checklists; receiving inspections with photo evidence.</p>
    <p><strong>Outcome:</strong> Better vendor quality; reduced repeats; clearer accountability.</p>
    <img src="/assets/img/projects/componentqa_full_1.jpg" alt="QA checklist example">
    <img src="/assets/img/projects/componentqa_full_2.jpg" alt="Receiving inspection photos">
  </template>

  <template id="case-tasklib">
    <h2>Preventive Task Library (RCM)</h2>
    <p><strong>Problem:</strong> Inconsistent preventive tasks across machines/teams.</p>
    <p><strong>Analysis:</strong> Compared OEM manuals vs. actuals; gaps & overlaps identified.</p>
    <p><strong>Action:</strong> Standard task library with intervals and torque/spec data; trained planners/techs.</p>
    <p><strong>Outcome:</strong> Fewer misses; clearer expectations; faster onboarding.</p>
    <img src="/assets/img/projects/tasklib_full_1.jpg" alt="Task library index">
    <img src="/assets/img/projects/tasklib_full_2.jpg" alt="Standard work details">
  </template>

  <template id="case-rcmhaul">
    <h2>ADT Haul Cycle RCM</h2>
    <p><strong>Problem:</strong> Haul cycle downtime and variability.</p>
    <p><strong>Analysis:</strong> Failure modes across drivetrain/axles; usage patterns.</p>
    <p><strong>Action:</strong> Task tuning and intervals aligned to usage; operator feedback loop.</p>
    <p><strong>Outcome:</strong> Availability up; fewer mid-shift failures.</p>
    <img src="/assets/img/projects/rcmhaul_full_1.jpg" alt="RCM worksheet">
    <img src="/assets/img/projects/rcmhaul_full_2.jpg" alt="Intervals vs usage trend">
  </template>

  <template id="case-filterskid">
    <h2>Filter Skid & Contamination Barriers</h2>
    <p><strong>Problem:</strong> Particulate ingress causing accelerated wear.</p>
    <p><strong>Analysis:</strong> Contamination paths; port protection gaps.</p>
    <p><strong>Action:</strong> Filtration skid; quick-connects; improved seals.</p>
    <p><strong>Outcome:</strong> Cleaner systems; reduced wear rates.</p>
    <img src="/assets/img/projects/filterskid_full_1.jpg" alt="Filter skid in use">
    <img src="/assets/img/projects/filterskid_full_2.jpg" alt="Quick-connect detail">
  </template>

  <template id="case-spares">
    <h2>Critical Spares Planning</h2>
    <p><strong>Problem:</strong> Stockouts on critical parts delaying repairs.</p>
    <p><strong>Analysis:</strong> MTBF, lead time, and usage variability reviewed.</p>
    <p><strong>Action:</strong> Min/Max stocking; vendor agreements; review cadence.</p>
    <p><strong>Outcome:</strong> Fewer delays; repairs start on time.</p>
    <img src="/assets/img/projects/spares_full_1.jpg" alt="Spares planning board">
    <img src="/assets/img/projects/spares_full_2.jpg" alt="Min/Max settings in tool">
  </template>

  <!-- ===== Modal dialog with Next/Prev ===== -->
  <dialog class="case-dialog" aria-label="Project case study">
    <button class="case-close" aria-label="Close case study">×</button>
    <button class="case-prev" aria-label="Previous project">‹</button>
    <button class="case-next" aria-label="Next project">›</button>
    <div class="case-media"><img alt=""></div>
    <div class="case-body"><!-- populated from template --></div>
  </dialog>

  <!-- AOS (deferred) + modal wiring -->
  
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  if (window.AOS) AOS.init({ once:true, duration:700, easing:'ease-out-cubic' });

  // Mobile nav toggle
  const toggle = document.querySelector('.menu-toggle');
  const links = document.getElementById('nav-links');
  if (toggle && links) {
    toggle.addEventListener('click', () => {
      const open = links.classList.toggle('show');
      toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
  }

  // Header shadow on scroll
  const header = document.querySelector('.site-header');
  const setShadow = () => header.classList.toggle('scrolled', window.scrollY > 8);
  setShadow(); window.addEventListener('scroll', setShadow, { passive:true });

  // ===== Cards and IDs =====
  const cards = Array.from(document.querySelectorAll('.project-card'));
  const ids = cards.map(c => c.getAttribute('data-case'));

  // ===== Dialog wiring =====
  const dlg = document.querySelector('.case-dialog');
  const dlgImg = dlg.querySelector('.case-media img');
  const dlgBody = dlg.querySelector('.case-body');
  const btnClose = dlg.querySelector('.case-close');
  const btnPrev = dlg.querySelector('.case-prev');
  const btnNext = dlg.querySelector('.case-next');

  let currentIndex = 0;
  let gallery = []; // [{src,alt}]
  let galleryIdx = 0;
  let lastFocus = null; // for focus restore

  function loadCase(id){
    const tpl = document.getElementById('case-' + id);
    if (!tpl) return;

    // Reset content
    dlgBody.innerHTML = '';
    gallery = [];
    galleryIdx = 0;

    // Clone template
    const frag = tpl.content.cloneNode(true);

    // Extract images for gallery
    frag.querySelectorAll('img').forEach(img => {
      gallery.push({ src: img.getAttribute('src'), alt: img.getAttribute('alt') || '' });
      img.remove(); // only text stays in body
    });

    // Set first image (if any)
    if (gallery.length) {
      dlgImg.src = gallery[0].src;
      dlgImg.alt = gallery[0].alt;
      galleryIdx = 0;
    } else {
      dlgImg.src = ''; dlgImg.alt = '';
    }

    // Body text
    dlgBody.appendChild(frag);
  }

  function openCaseAt(index){
    currentIndex = (index + ids.length) % ids.length;
    loadCase(ids[currentIndex]);
    if (typeof dlg.showModal === 'function') {
      lastFocus = document.activeElement;
      dlg.setAttribute('aria-modal','true');
      dlg.showModal();
      setHashForCurrent();        // sync URL
      trapFocusStart();           // focus management
    }
  }

  function stepCase(dir){ openCaseAt(currentIndex + dir); }
  function stepImage(dir){
    if (!gallery.length) return;
    galleryIdx = (galleryIdx + dir + gallery.length) % gallery.length;
    dlgImg.src = gallery[galleryIdx].src;
    dlgImg.alt = gallery[galleryIdx].alt || '';
  }

  // Wire cards (button inside each)
  cards.forEach((card, i) => {
    const btn = card.querySelector('.project-open');
    if (!btn) return;
    btn.addEventListener('click', () => openCaseAt(i));
    btn.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openCaseAt(i); }
    });
  });

  // Controls
  btnClose.addEventListener('click', () => closeDialog());
  btnPrev.addEventListener('click', () => stepCase(-1));
  btnNext.addEventListener('click', () => stepCase(1));
  dlgImg.addEventListener('click', (e) => stepImage(e.shiftKey ? -1 : 1));

  function closeDialog(){
    dlg.close();
    clearHashCase();
    if (lastFocus && document.body.contains(lastFocus)) lastFocus.focus();
  }

  // Backdrop & keys
  dlg.addEventListener('click', (e) => { if (e.target === dlg) closeDialog(); });
  document.addEventListener('keydown', (e) => {
    if (!dlg.open) return;
    if (e.key === 'Escape') closeDialog();
    if (e.key === 'ArrowRight') stepCase(1);
    if (e.key === 'ArrowLeft') stepCase(-1);
    if (e.key === 'PageDown') stepImage(1);
    if (e.key === 'PageUp') stepImage(-1);
  });

  // ===== Focus trap inside dialog =====
  function trapFocusStart(){
    // Move initial focus to the dialog's close button
    btnClose.focus();
  }
  dlg.addEventListener('keydown', (e) => {
    if (e.key !== 'Tab') return;
    const focusables = dlg.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const list = Array.from(focusables).filter(el => !el.hasAttribute('disabled'));
    if (!list.length) return;
    const first = list[0], last = list[list.length - 1];
    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  });

  // ===== Filtering =====
  const chips = Array.from(document.querySelectorAll('.project-filters .chip'));
  const status = document.getElementById('filterStatus');

  function applyFilter(tag){
    const t = (tag || 'all').toLowerCase();
    const params = new URLSearchParams(location.search);
    if (t === 'all') params.delete('filter'); else params.set('filter', t);
    const newUrl = location.pathname + (params.toString() ? '?' + params.toString() : '') + location.hash;
    history.replaceState({}, '', newUrl);

    let visible = 0;
    cards.forEach(card => {
      const tags = (card.getAttribute('data-tags') || '').toLowerCase();
      const show = (t === 'all') || tags.split(',').map(s => s.trim()).includes(t);
      card.hidden = !show;
      if (show) visible++;
    });
    // Update chip styles & pressed state
    chips.forEach(c => {
      const on = c.dataset.filter === t || (t==='all' && c.dataset.filter==='all');
      c.classList.toggle('is-active', on);
      c.setAttribute('aria-pressed', on ? 'true' : 'false');
    });
    if (status) status.textContent = `${visible} project${visible===1?'':'s'} shown for filter: ${t}.`;
  }

  chips.forEach(chip => chip.addEventListener('click', () => applyFilter(chip.dataset.filter)));

  // ===== Deep-linking for cases =====
  function setHashForCurrent(){
    const id = ids[currentIndex];
    const params = new URLSearchParams(location.search);
    const url = location.pathname + (params.toString() ? '?' + params.toString() : '') + '#case-' + id;
    history.replaceState({}, '', url);
  }
  function clearHashCase(){
    const params = new URLSearchParams(location.search);
    const url = location.pathname + (params.toString() ? '?' + params.toString() : '');
    history.replaceState({}, '', url);
  }
  function openFromUrl(){
    const params = new URLSearchParams(location.search);
    const filter = params.get('filter');
    if (filter) applyFilter(filter); else applyFilter('all');

    const hash = location.hash || '';
    const caseMatch = hash.match(/^#case-([a-z0-9_-]+)$/i);
    const queryCase = new URLSearchParams(location.search).get('case');
    const wanted = caseMatch ? caseMatch[1] : (queryCase || null);
    if (wanted) {
      const idx = ids.indexOf(wanted);
      if (idx >= 0) openCaseAt(idx);
    }
  }
  window.addEventListener('hashchange', () => {
    const hash = location.hash || '';
    const m = hash.match(/^#case-([a-z0-9_-]+)$/i);
    if (!m) { if (dlg.open) closeDialog(); return; }
    const idx = ids.indexOf(m[1]);
    if (idx >= 0) openCaseAt(idx);
  });

  openFromUrl(); // initial load
});
</script>

</body>
</html>
